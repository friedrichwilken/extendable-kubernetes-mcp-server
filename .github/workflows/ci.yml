name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.25'

jobs:
  # Stage 1: Fast feedback with unit tests and linting
  unit-tests-and-lint:
    name: Unit Tests & Linting
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Fetch full history for better golangci-lint performance
        fetch-depth: 0

    - name: Checkout kubernetes-mcp-server dependency
      uses: actions/checkout@v4
      with:
        repository: containers/kubernetes-mcp-server
        path: ../kubernetes-mcp-server
        ref: main

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: go.sum

    - name: Download dependencies
      run: go mod download

    - name: Run gofumpt formatting check
      run: |
        go install mvdan.cc/gofumpt@latest
        if [ "$(gofumpt -l .)" != "" ]; then
          echo "Code is not properly formatted. Run 'make fmt-modern' to fix."
          gofumpt -l .
          exit 1
        fi

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: latest
        args: --timeout=5m

    - name: Run unit tests
      run: make test-unit

    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          coverage.out
        retention-days: 30

  # Stage 2: Comprehensive testing in parallel
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests-and-lint
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Checkout kubernetes-mcp-server dependency
      uses: actions/checkout@v4
      with:
        repository: containers/kubernetes-mcp-server
        path: ../kubernetes-mcp-server
        ref: main

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: go.sum

    - name: Download dependencies
      run: go mod download

    - name: Set up envtest binaries
      run: make setup-envtest

    - name: Run integration tests
      run: make test-integration

    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          coverage.out
        retention-days: 30

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: unit-tests-and-lint
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Checkout kubernetes-mcp-server dependency
      uses: actions/checkout@v4
      with:
        repository: containers/kubernetes-mcp-server
        path: ../kubernetes-mcp-server
        ref: main

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: go.sum

    - name: Download dependencies
      run: go mod download

    - name: Run E2E tests
      run: make test-e2e

    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: |
          coverage.out
        retention-days: 30

  # Build and test binaries
  build:
    name: Build & Test Binaries
    runs-on: ${{ matrix.os }}
    needs: unit-tests-and-lint
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
        - os: ubuntu-latest
          binary-name: extendable-k8s-mcp-linux
        - os: macos-latest
          binary-name: extendable-k8s-mcp-darwin
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Checkout kubernetes-mcp-server dependency
      uses: actions/checkout@v4
      with:
        repository: containers/kubernetes-mcp-server
        path: ../kubernetes-mcp-server
        ref: main

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: go.sum

    - name: Download dependencies
      run: go mod download

    - name: Build binary
      run: make build

    - name: Test binary execution
      run: |
        ./build/extendable-k8s-mcp --version
        ./build/extendable-k8s-mcp --help

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.binary-name }}
        path: build/extendable-k8s-mcp
        retention-days: 30

  # Coverage reporting (runs after all tests complete)
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [integration-tests, e2e-tests]
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Checkout kubernetes-mcp-server dependency
      uses: actions/checkout@v4
      with:
        repository: containers/kubernetes-mcp-server
        path: ../kubernetes-mcp-server
        ref: main

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "*test-results"
        path: test-results
        merge-multiple: true

    - name: Generate comprehensive coverage report
      run: |
        # Run all tests together for combined coverage
        make test-coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.html
        flags: unittests,integration,e2e
        name: codecov-umbrella
        fail_ci_if_error: false

  # Final status check
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [unit-tests-and-lint, integration-tests, e2e-tests, build, coverage]
    if: always()
    steps:
    - name: Check CI status
      run: |
        if [[ "${{ needs.unit-tests-and-lint.result }}" != "success" ]]; then
          echo "Unit tests or linting failed"
          exit 1
        fi
        if [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
          echo "Integration tests failed"
          exit 1
        fi
        if [[ "${{ needs.e2e-tests.result }}" != "success" ]]; then
          echo "E2E tests failed"
          exit 1
        fi
        if [[ "${{ needs.build.result }}" != "success" ]]; then
          echo "Build failed"
          exit 1
        fi
        echo "All CI checks passed successfully! ðŸš€"