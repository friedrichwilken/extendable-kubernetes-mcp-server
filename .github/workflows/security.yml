name: Security & Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly security scans
    - cron: "0 6 * * 1"

env:
  GO_VERSION: "1.25"

jobs:
  # Security scanning and vulnerability detection
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6.1.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: Download dependencies
        run: go mod download

      - name: Install Gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@v2.22.10

      - name: Run Gosec security scanner
        run: gosec -fmt sarif -out gosec-results.sarif ./...

      - name: Upload Gosec results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4.31.4
        if: always()
        with:
          sarif_file: gosec-results.sarif

      - name: Upload Gosec results as artifact
        uses: actions/upload-artifact@v4.5.0
        if: always()
        with:
          name: gosec-results
          path: gosec-results.sarif
          retention-days: 30

  # CodeQL analysis for comprehensive security scanning
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    strategy:
      fail-fast: false
      matrix:
        language: ["go"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4.31.4
        with:
          languages: ${{ matrix.language }}

      - name: Set up Go
        uses: actions/setup-go@v6.1.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4.31.4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4.31.4

  # Advanced linting and code quality checks
  advanced-linting:
    name: Advanced Linting & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6.1.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: Download dependencies
        run: go mod download

      - name: Install additional linters
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@2025.1.1
          go install golang.org/x/tools/cmd/goimports@latest
          curl -L https://github.com/crate-ci/typos/releases/download/v1.39.2/typos-v1.39.2-x86_64-unknown-linux-musl.tar.gz | tar -xzf - ./typos
          sudo mv typos /usr/local/bin/

      - name: Run staticcheck
        run: staticcheck ./...

      - name: Check imports formatting
        run: |
          if [ "$(find . -name '*.go' -exec goimports -l {} \;)" != "" ]; then
            echo "The following files have import formatting issues:"
            find . -name '*.go' -exec goimports -l {} \;
            echo "Run 'goimports -w .' to fix these issues"
            exit 1
          fi

      - name: Check for misspellings
        run: |
          typos --exclude "go.mod" --exclude "go.sum" .

      - name: Run go vet with additional checks
        run: |
          go vet ./...
          go install golang.org/x/tools/go/analysis/passes/shadow/cmd/shadow@v0.39.0
          shadow ./...

      - name: Check Go module tidiness
        run: |
          go mod tidy
          if [ "$(git status --porcelain go.mod go.sum)" != "" ]; then
            echo "go.mod or go.sum is not tidy"
            git diff go.mod go.sum
            exit 1
          fi

      - name: Detect code complexity issues
        run: |
          go install github.com/fzipp/gocyclo/cmd/gocyclo@v0.6.0
          # Check for functions with cyclomatic complexity > 10
          if [ "$(gocyclo -over 10 .)" != "" ]; then
            echo "The following functions have high cyclomatic complexity:"
            gocyclo -over 10 .
            echo "Consider refactoring to reduce complexity"
            # Don't fail the build, just warn
          fi

  # Dependency scanning and license checking
  dependency-scan:
    name: Dependency Security & License Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.0

      - name: Set up Go
        uses: actions/setup-go@v6.1.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run govulncheck (Go vulnerability scanner)
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@v1.1.4
          govulncheck ./...

      - name: Generate software bill of materials (SBOM)
        run: |
          go install github.com/anchore/syft/cmd/syft@v1.38.0
          syft packages . -o spdx-json=sbom.spdx.json
          syft packages . -o table=sbom.txt

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4.5.0
        with:
          name: software-bill-of-materials
          path: |
            sbom.spdx.json
            sbom.txt
          retention-days: 90

  # Final security status check
  security-status:
    name: Security Status Check
    runs-on: ubuntu-latest
    needs: [security-scan, codeql-analysis, advanced-linting, dependency-scan]
    if: always()
    steps:
      - name: Check all security jobs status
        run: |
          echo "Security scan result: ${{ needs.security-scan.result }}"
          echo "CodeQL analysis result: ${{ needs.codeql-analysis.result }}"
          echo "Advanced linting result: ${{ needs.advanced-linting.result }}"
          echo "Dependency scan result: ${{ needs.dependency-scan.result }}"

          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "‚ùå Security scan failed or was canceled"
            exit 1
          fi
          if [[ "${{ needs.codeql-analysis.result }}" != "success" ]]; then
            echo "‚ùå CodeQL analysis failed or was canceled"
            exit 1
          fi
          if [[ "${{ needs.advanced-linting.result }}" != "success" ]]; then
            echo "‚ùå Advanced linting failed or was canceled"
            exit 1
          fi
          if [[ "${{ needs.dependency-scan.result }}" != "success" ]]; then
            echo "‚ùå Dependency scan failed or was canceled"
            exit 1
          fi

          echo "‚úÖ All security and code quality checks passed successfully! üîí"

